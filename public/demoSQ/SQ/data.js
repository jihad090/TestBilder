// var sqDataBan = [
//   {
//     "id": "1",
//     "question": `ঢাকা শহরে যানজটের প্রধান কারণ কী?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "2",
//     "question": `বাংলাদেশে জলবায়ু পরিবর্তনের ফলে সমুদ্রপৃষ্ঠের উচ্চতা বৃদ্ধির প্রভাব বিশদভাবে বর্ণনা করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "3",
//     "question": `তাপমাত্রা বৃদ্ধির তিনটি প্রধান কারণ লিখুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "4",
//     "question": `নদীভাঙনের ফলে চরাঞ্চলের কৃষকদের মুখোমুখি হওয়া চ্যালেঞ্জগুলো বিশ্লেষণ করুন এবং স্থায়ী সমাধানের পরামর্শ দিন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "5",
//     "question": `PM2.5 এবং PM10 এর মধ্যে পার্থক্য কী?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "6",
//     "question": `লবণাক্ত পানি প্রবেশের ফলে উপকূলীয় অঞ্চলের জনস্বাস্থ্যের উপর প্রভাব সম্পর্কে একটি বিস্তারিত প্রতিবেদন তৈরি করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "7",
//     "question": `পরিবেশ দূষণের তিনটি প্রকার উল্লেখ করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "8",
//     "question": `ঘূর্ণিঝড় ও বন্যার সময় বাংলাদেশের অবকাঠামোগত দুর্বলতা এবং এর সমাধানের উপায় নিয়ে একটি নিবন্ধ রচনা করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "9",
//     "question": `ঢাকার সবচেয়ে বেশি ব্যবহৃত তিনটি যানবাহনের নাম লিখুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "10",
//     "question": `শব্দদূষণ নিয়ন্ত্রণের জন্য সরকারি ও ব্যক্তিগত পর্যায়ে গৃহীত পদক্ষেপগুলোর একটি তুলনামূলক বিশ্লেষণ প্রদান করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "11",
//     "question": `যানজটের কারণে অর্থনৈতিক ক্ষতির পরিমাণ কত?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "12",
//     "question": `বাংলাদেশের নদ-নদী রক্ষায় সরকারি ও বেসরকারি সংস্থাগুলোর ভূমিকা মূল্যায়ন করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "13",
//     "question": `বায়ুদূষণ নিয়ন্ত্রণের দুটি উপায় লিখুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "14",
//     "question": `শহর ও গ্রামীণ পরিবেশের মধ্যে পার্থক্য বিশ্লেষণ করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "15",
//     "question": `মেট্রোরেল কিভাবে যানজট কমাতে সাহায্য করতে পারে?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "16",
//     "question": `জলবায়ু উদ্বাস্তু বলতে কী বোঝায়?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "17",
//     "question": `বাংলাদেশের পরিবেশ সংরক্ষণে তরুণদের ভূমিকা নিয়ে একটি প্রতিবেদন লিখুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "18",
//     "question": `টেকসই উন্নয়ন লক্ষ্যমাত্রা অর্জনে বাংলাদেশের অগ্রগতি মূল্যায়ন করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "19",
//     "question": `প্রাকৃতিক দুর্যোগ মোকাবেলায় বাংলাদেশের প্রস্তুতি পর্যাপ্ত কিনা তা যুক্তিসহ ব্যাখ্যা করুন।`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "20",
//     "question": `আপনার স্কুলে পরিবেশ সংরক্ষণ বিষয়ে কী কী কার্যক্রম গ্রহণ করা যেতে পারে?`,
//     "questionImgSrc": ""
//   }
// ]
// var sqDataEng = [
//   {
//     "id": "1",
//     "question": `What are the main causes of traffic congestion in Dhaka city?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "2",
//     "question": `Describe in detail the impacts of rising sea levels due to climate change in Bangladesh.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "3",
//     "question": `List three main causes of temperature rise.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "4",
//     "question": `Analyze the challenges faced by farmers in char areas due to river erosion and suggest permanent solutions.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "5",
//     "question": `What is the difference between PM2.5 and PM10?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "6",
//     "question": `Prepare a detailed report on the public health impacts of saline water intrusion in coastal areas.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "7",
//     "question": `Name three types of environmental pollution.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "8",
//     "question": `Write an article about Bangladesh's infrastructural weaknesses during cyclones and floods, and possible solutions.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "9",
//     "question": `Name the three most used vehicles in Dhaka.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "10",
//     "question": `Provide a comparative analysis of government and private sector initiatives to control noise pollution.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "11",
//     "question": `What is the economic loss caused by traffic congestion?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "12",
//     "question": `Evaluate the role of government and non-government organizations in protecting Bangladesh's rivers.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "13",
//     "question": `List two methods to control air pollution.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "14",
//     "question": `Analyze the differences between urban and rural environments.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "15",
//     "question": `How can metro rail help reduce traffic congestion?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "16",
//     "question": `What is meant by climate refugee?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "17",
//     "question": `Write a report on the role of youth in environmental conservation in Bangladesh.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "18",
//     "question": `Assess Bangladesh's progress in achieving Sustainable Development Goals.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "19",
//     "question": `With logical arguments, explain whether Bangladesh's preparedness for natural disasters is adequate.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "20",
//     "question": `What environmental conservation activities could be implemented in your school?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "11",
//     "question": `What is the economic loss caused by traffic congestion?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "12",
//     "question": `Evaluate the role of government and non-government organizations in protecting Bangladesh's rivers.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "13",
//     "question": `List two methods to control air pollution.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "14",
//     "question": `Analyze the differences between urban and rural environments.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "15",
//     "question": `How can metro rail help reduce traffic congestion?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "16",
//     "question": `What is meant by climate refugee?`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "17",
//     "question": `Write a report on the role of youth in environmental conservation in Bangladesh.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "18",
//     "question": `Assess Bangladesh's progress in achieving Sustainable Development Goals.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "19",
//     "question": `With logical arguments, explain whether Bangladesh's preparedness for natural disasters is adequate.`,
//     "questionImgSrc": ""
//   },
//   {
//     "id": "20",
//     "question": `What environmental conservation activities could be implemented in your school?`,
//     "questionImgSrc": ""
//   }
// ]



// const institutionName = "Chittagong Government City College"
// const examName = "mid term" //examName
// const subject = "physics" //subject
// const paper = "1st" //paper
// const className = 10 //class
// const totalMark = 30 // totalMark
// const subjectCode = 101 //subjectCode
// const totalTime = "30 minute" //totalTime
// const message = ""



const urlParams = new URLSearchParams(window.location.search)
const templateId = urlParams.get("templateId")

// Global array to store generated HTML for all sets
const superArray = []

// Function to convert database SQ format to script format
function convertSQData(apiSqData) {
  if (!apiSqData || !apiSqData.sqGroup || !Array.isArray(apiSqData.sqGroup.questions)) {
    return []
  }

  return apiSqData.sqGroup.questions.map((sq, index) => ({
    id: sq.id || (index + 1).toString(),
    question: sq.questionText || "",
    questionImgSrc: sq.image || "",
    marks: sq.marks || 2,
  }))
}

// Function to shuffle an array (used for SQs)
function shuffleArray(array) {
  return [...array].sort(() => Math.random() - 0.5)
}

// Main data fetching and initiation logic
document.addEventListener("DOMContentLoaded", async () => {
  const loadingDiv = document.querySelector(".loading")
  const errorDiv = document.querySelector(".error")

  if (loadingDiv) loadingDiv.style.display = "flex"
  if (errorDiv) errorDiv.style.display = "none"

  if (!templateId) {
    console.error("No templateId provided in URL")
    if (loadingDiv) loadingDiv.style.display = "none"
    if (errorDiv) {
      errorDiv.innerHTML = `
        <h2>Error Loading SQ Data</h2>
        <p>Template ID missing from URL.</p>
        <button onclick='window.location.reload()' style='margin-top: 20px; padding: 10px 20px; font-size: 16px;'>Retry</button>
      `
      errorDiv.style.display = "flex"
    }
    return
  }

  try {
    const res = await fetch(`/Api/sq?templateId=${templateId}`)
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`)
    }
    const result = await res.json()

    if (!result.success || !result.data) {
      throw new Error(result.message || "SQ data not found")
    }

    const data = result.data

    let primaryInfo = {}
    if (typeof data.primaryInfo === "object" && data.primaryInfo !== null && data.primaryInfo.institutionName) {
      primaryInfo = data.primaryInfo
    } else if (data.primaryInfo) {
      try {
        const primaryRes = await fetch(`/Api/createQuestionPrimaryInfo?primaryId=${data.primaryInfo}`)
        const primaryData = await primaryRes.json()
        if (primaryData.success) {
          primaryInfo = primaryData.data
        } else {
          throw new Error("Failed to fetch primary info")
        }
      } catch (err) {
        console.error("Error fetching primary info:", err)
        primaryInfo = {} 
      }
    }

    console.log("Raw primaryInfo object:", primaryInfo)
    console.log("Raw primaryInfo.setCount:", primaryInfo.setCount)

    window.sqMeta = {
      institutionName: primaryInfo.institutionName || "Institution Name",
      examName: primaryInfo.examName || "Exam Name",
      subject: primaryInfo.subject || "Subject",
      paper: primaryInfo.paper || "",
      className: primaryInfo.class || primaryInfo.className || "Class",
      totalMark: primaryInfo.totalMark || "30",
      subjectCode: primaryInfo.subjectCode || "101",
      totalTime: primaryInfo.totalTime || "30 minutes",
      message: primaryInfo.message || "",
      setCount: Number.parseInt(String(primaryInfo.setCount || primaryInfo.totalSet || "1").trim()) || 1,
    }

    console.log("Parsed sqMeta.setCount:", window.sqMeta.setCount) 

    const originalSqData = convertSQData(data)

    if (originalSqData.length === 0) {
      if (loadingDiv) loadingDiv.style.display = "none"
      if (errorDiv) {
        errorDiv.innerHTML = `
          <h2>No SQ Questions Found</h2>
          <p>There are no questions associated with this template.</p>
          <button onclick='window.location.reload()' style='margin-top: 20px; padding: 10px 20px; font-size: 16px;'>Go Back</button>
        `
        errorDiv.style.display = "flex"
      }
      return
    }

    window.originalSqData = originalSqData

    if (typeof window.infiniteSQ === "function") {
      for (let i = 0; i < window.sqMeta.setCount; i++) {
        console.log(`Generating SQ set ${i + 1} of ${window.sqMeta.setCount}`) 
        const shuffledSqData = shuffleArray(originalSqData)
        await window.infiniteSQ(shuffledSqData, window.sqMeta, i) 
        superArray.push(document.body.innerHTML) 
      }

      document.body.innerHTML = ""
      for (let i = 0; i < superArray.length; i++) {
        document.body.innerHTML += superArray[i]
      }

      if (loadingDiv) loadingDiv.style.display = "none"
      console.log("SQ rendering completed for all sets")
    } else {
      console.warn("window.infiniteSQ not found. Script might not execute.")
      if (loadingDiv) loadingDiv.style.display = "none"
      if (errorDiv) {
        errorDiv.innerHTML = `
          <h2>Rendering Error</h2>
          <p>The rendering script did not load correctly. Please try again.</p>
          <button onclick='window.location.reload()' style='margin-top: 20px; padding: 10px 20px; font-size: 16px;'>Retry</button>
        `
        errorDiv.style.display = "flex"
      }
    }
  } catch (err) {
    console.error("SQ data fetch or render error:", err)
    if (loadingDiv) loadingDiv.style.display = "none"
    if (errorDiv) {
      errorDiv.innerHTML = `
        <h2>Error Loading SQ Data</h2>
        <p>${err.message}</p>
        <p>Template ID: ${templateId}</p>
        <button onclick='window.location.reload()' style='margin-top: 20px; padding: 10px 20px; font-size: 16px;'>Retry</button>
      `
      errorDiv.style.display = "flex"
    }
  }
})
